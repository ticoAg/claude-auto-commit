# 实现原理（SDK 版）

> 更新日期：2025-11-03 · 适用版本：v0.1.x（Node.js 22+ / Claude Code SDK）

本文面向中文团队，系统说明 `claude-auto-commit` 的整体架构、关键流程与设计取舍，帮助二次开发与排障。

## 设计目标
- 将 AI 驱动的提交消息生成无缝融入 Git 日常工作流（最少侵入）。
- 输出稳定、可读、可复用（模板化）的提交信息。
- 以“同步流程”为默认，优先保证确定性与可追踪性，性能按需优化。

## 关键依赖
- 运行时：Node.js 22+（ESM 模块）
- SDK：Claude Code SDK（复用系统已登录的 `claude` 可执行程序）
- 配置：`~/.claude-auto-commit/config.yml` 优先，兼容 `config.json`

## 总体架构
- 可执行入口：`bin/claude-auto-commit`（调用 `src/claude-auto-commit.js` 导出的 `main()`）
- 主类：`ClaudeAutoCommit`（单文件实现，职责清晰）
- 主要子系统：
  - 配置加载（YAML 优先、JSON 兼容、5 分钟缓存）
  - Git 变更采集（并行命令、结果缓存、超大输出截断）
  - 提示词生成（根据语言/规范/类型拼装）
  - 文本生成（Claude Code SDK，30 秒超时，最多 3 次重试，指数退避）
  - 提交执行（可选 `--dry-run`、模板保存/应用、自动 `push`）
  - 观测与日志（`--verbose` 时输出结构化日志，含 `trace_id`）

## 时序流程
1) 预检阶段
   - 读取配置（YAML → JSON），合并命令行参数；
   - 校验当前目录为 Git 仓库；
   - 解析 `claude` 可执行路径（配置 `claudePath` 或 PATH 检测），并校验可用；
   - 生成 `trace_id` 并在后续关键节点随日志输出。

2) 变更采集
   - 并行执行：`git status --porcelain`、`git branch --show-current`、`git diff --cached --name-only`、`git diff --name-only`；
   - 按需补充 `--stat` 汇总；
   - 对采集结果进行拼装与长度截断（> 4KB 截断，避免提示词过长）。

3) 提示词构造
   - 根据 `language` / `conventionalCommit` / `useEmoji` / `commitType` 拼装；
   - 中/英/日三语模板按需切换；
   - 仅输出“最终提交信息”的硬性约束，减少跑偏。

4) 文本生成
   - 使用 Claude Code SDK，显式绑定 `pathToClaudeCodeExecutable`（复用登录状态）；
   - 监听 SDK 关键阶段事件，`--verbose` 模式打印摘要（turns、duration、cost）；
   - 解析 `result` 优先，其次回退解析 `assistant` 文本；
   - 失败重试：最多 3 次，指数退避 1s → 2s → 4s（上限 10s）。

5) 提交与推送
   - 默认自动 `git add .`；
   - `--dry-run`：仅生成不提交；
   - `--save-template <name>`：在 dry‑run 下保存模板到 `~/.claude-auto-commit/templates/`；
   - `--template <name>`：绕过生成直接提交；
   - `--push`：将当前分支 `git push origin <branch>`。

6) 观测与可追踪性
   - `--verbose` 时输出结构化 JSON 日志（带 `trace_id`、phase、metrics、error 等），便于排障与上报。

## 性能策略
- Git 命令并行；
- 结果缓存（`status`/`branch` 等在单次运行内复用）；
- 超长内容截断（控制提示词体积）；
- SDK 超时 + 指数退避重试；
- 可选模板流实现“离线路径”（无外网亦可自测提交流程）。

## 稳定性与边界
- 工作区干净直接退出（可读提示，不抛异常）；
- 推送失败不会中断流程（给出手动命令建议）；
- 若未检测到 `claude` 可执行，将给出明确安装/登录提示；
- JSON 配置被读取时打印迁移提示（鼓励改用 YAML）。

## 与旧版差异（相对 CLI .sh）
- 完全切换到 SDK；
- 取消“自动更新”机制；
- 更强的观测性与稳定性（结构化日志 / 重试 / 超时）。

## 二次开发建议
- 在 `buildPrompt()` 收敛所有提示词策略；
- 扩展参数尽量通过配置覆盖 CLI 选项；
- 若引入新依赖，优先考虑同步流程与可控的失败模式；
- 对外接口变更需同步更新 `docs/zh-CN` 与根 `README.md` 的对应章节。

