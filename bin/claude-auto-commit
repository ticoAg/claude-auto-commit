#!/usr/bin/env node

import path from "path";
import { fileURLToPath } from "url";

const __filename = fileURLToPath(import.meta.url);
const __dirname = path.dirname(__filename);

// 统一版本来源：从 package.json 读取版本号，避免手工同步
import { createRequire } from "module";
const require = createRequire(import.meta.url);
const pkg = require("../package.json");
const CLI_VERSION = `v${pkg.version}`;

// Handle version and help commands before importing main script
const args = process.argv.slice(2);
if (args.includes("--version")) {
    console.log(`Claude Auto Commit ${CLI_VERSION}`);
    process.exit(0);
}

if (args.includes("--help") || args.includes("-h")) {
    console.log(`
Claude Auto Commit (SDK Version ${CLI_VERSION})

Usage: claude-auto-commit [options]

Options:
  -l, --language <lang>       Language for commit message (en, ja, zh)
  -e, --emoji                Include emojis in commit message
  -c, --conventional         Use Conventional Commits format
  -t, --type <type>          Specify commit type (feat, fix, docs, etc.)
  -d, --dry-run              Preview commit message without creating commit
  -v, --verbose              Verbose output
  -p, --push                 Push changes after commit
  --template <name>          Use saved template
  --save-template <name>     Save generated message as template (dry-run only)
  --list-templates           List available templates
  --version                  Show version information
  -h, --help                 Show this help message

Examples:
  claude-auto-commit
  claude-auto-commit -l ja -e -c
  claude-auto-commit -l zh -e -c
  claude-auto-commit -t feat --push
  claude-auto-commit --dry-run --save-template my-template
  claude-auto-commit --template my-template

Configuration:
  Preferred: ~/.claude-auto-commit/config.yml (YAML)
  Compatible: ~/.claude-auto-commit/config.json (JSON, deprecated)
  `);
    process.exit(0);
}

// Import and run the main script（干净方案：调用导出的 main()）
const scriptPath = path.join(__dirname, "..", "src", "claude-auto-commit.js");

try {
    // 中文说明：直接调用模块导出的 main()，避免依赖“是否直接执行”的判断
    const mod = await import(scriptPath);
    if (typeof mod.main === "function") {
        await mod.main();
    } else {
        // 兜底：若未导出 main，则回退为直接导入（兼容旧实现）
        await import(scriptPath);
    }
} catch (error) {
    console.error("运行 claude-auto-commit 时出错:", error.message);
    process.exit(1);
}
