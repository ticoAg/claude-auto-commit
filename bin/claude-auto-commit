#!/usr/bin/env node

import path from "path";
import { fileURLToPath } from "url";

const __filename = fileURLToPath(import.meta.url);
const __dirname = path.dirname(__filename);

// 统一版本来源：从 package.json 读取版本号，避免手工同步
import { createRequire } from "module";
const require = createRequire(import.meta.url);
const pkg = require("../package.json");
const CLI_VERSION = `v${pkg.version}`;

// Handle version and help commands before importing main script
const args = process.argv.slice(2);
if (args.includes("--version")) {
    console.log(`Claude Auto Commit ${CLI_VERSION}`);
    process.exit(0);
}

if (args.includes("--help") || args.includes("-h")) {
    // 中文优先的双语帮助文本；英文仅作补充，便于国际用户理解
    console.log(`
Claude Auto Commit (SDK 版本 ${CLI_VERSION}) / Claude Auto Commit (SDK Version ${CLI_VERSION})

用法 / Usage:
  claude-auto-commit [options]

选项 / Options:
  -l, --language <lang>       提交信息语言（en, ja, zh） / Language for commit message (en, ja, zh)
  -e, --emoji                 在提交信息中包含表情 / Include emojis in commit message
  -c, --conventional          使用 Conventional Commits 规范 / Use Conventional Commits format
  -t, --type <type>           指定提交类型（feat, fix, docs 等）/ Specify commit type (feat, fix, docs, etc.)
  -d, --dry-run               仅预览提交信息，不创建提交 / Preview commit message without creating commit
  -v, --verbose               输出详细日志 / Verbose output
  -p, --push                  提交后自动推送 / Push changes after commit
  --template <name>           使用已保存模板 / Use saved template
  --save-template <name>      将生成的信息保存为模板（仅 dry-run）/ Save generated message as template (dry-run only)
  --list-templates            列出可用模板 / List available templates
  --version                   显示版本信息 / Show version information
  -h, --help                  显示帮助信息 / Show this help message

示例 / Examples:
  claude-auto-commit
  claude-auto-commit -l ja -e -c
  claude-auto-commit -l zh -e -c
  claude-auto-commit -t feat --push
  claude-auto-commit --dry-run --save-template my-template
  claude-auto-commit --template my-template

配置 / Configuration:
  推荐 / Preferred: ~/.claude-auto-commit/config.yml (YAML)
  兼容 / Compatible: ~/.claude-auto-commit/config.json (JSON, deprecated)
  `);
    process.exit(0);
}

// Import and run the main script（干净方案：调用导出的 main()）
const scriptPath = path.join(__dirname, "..", "src", "claude-auto-commit.js");

try {
    // 中文说明：直接调用模块导出的 main()，避免依赖“是否直接执行”的判断
    const mod = await import(scriptPath);
    if (typeof mod.main === "function") {
        await mod.main();
    } else {
        // 兜底：若未导出 main，则回退为直接导入（兼容旧实现）
        await import(scriptPath);
    }
} catch (error) {
    console.error("运行 claude-auto-commit 时出错:", error.message);
    process.exit(1);
}
